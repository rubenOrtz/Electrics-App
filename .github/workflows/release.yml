name: ðŸš€ Production Release

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'
      - '.github/workflows/release.yml'

permissions:
  contents: write

jobs:
  # -----------------------------------------------------------------
  # JOB 1: QUALITY GATE & BUILD
  # -----------------------------------------------------------------
  verify-and-build:
    name: ðŸ›¡ï¸ Verify, Build & Package
    runs-on: ubuntu-latest
    outputs:
      app_name: ${{ steps.meta.outputs.APP_NAME }}
      version: ${{ steps.meta.outputs.VERSION }}
      version_tag: ${{ steps.meta.outputs.VERSION_TAG }}
      build_number: ${{ steps.meta.outputs.BUILD_NUMBER }}
      is_release: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. STRICT VERSION VALIDATION
      - name: ðŸ§  Extract & Validate Metadata
        id: meta
        run: |
          # Extraemos los valores usando yq (instalado por defecto en ubuntu-latest)
          APP_NAME=$(yq '.name' pubspec.yaml)
          VERSION_FULL=$(yq '.version' pubspec.yaml)
          
          echo "Buscando versiÃ³n: $VERSION_FULL"

          # VALIDACIÃ“N REGEX: Debe ser x.y.z+n
          if [[ ! "$VERSION_FULL" =~ ^[0-9]+\.[0-9]+\.[0-9]+\+[0-9]+$ ]]; then
            echo "â›” ERROR: Formato de versiÃ³n invÃ¡lido en pubspec.yaml"
            echo "   Encontrado: '$VERSION_FULL'"
            echo "   Formato requerido: x.y.z+n (ejemplo: 1.0.0+1)"
            exit 1
          fi
          
          # Extraer componentes
          VERSION_BASE=${VERSION_FULL%+*}
          BUILD_NUMBER=${VERSION_FULL#*+}
          
          echo "âœ… Validado: $APP_NAME v$VERSION_BASE (Build: $BUILD_NUMBER)"
          
          # Exportar al output del step
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=v$VERSION_BASE" >> $GITHUB_OUTPUT
          echo "VERSION_TAG=v$VERSION_BASE-b$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      # 2. VERSION INCREMENT CHECK
      - name: ðŸ” Verify Version Was Bumped
        if: github.event_name == 'workflow_dispatch'
        env:
          VERSION_TAG: ${{ steps.meta.outputs.VERSION_TAG }}
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0-b0")
          
          if [[ "$VERSION_TAG" == "$LATEST_TAG" ]]; then
            echo "â›” ERROR: Build number was not incremented!"
            echo "   Current tag: $VERSION_TAG"
            echo "   Latest tag: $LATEST_TAG"
            echo "   Action: Increment build number in pubspec.yaml (e.g., 1.0.0+1 -> 1.0.0+2)"
            exit 1
          fi
          
          echo "âœ… Version bumped from $LATEST_TAG to $VERSION_TAG"

      # 3. GIT TAG COLLISION CHECK
      - name: ðŸ›‘ Check Tag Uniqueness
        if: github.event_name == 'workflow_dispatch'
        env:
          TAG: ${{ steps.meta.outputs.VERSION_TAG }}
        run: |
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "â›” ERROR: Git tag '$TAG' already exists"
            echo "   Action: Increment build number in pubspec.yaml"
            exit 1
          fi
          echo "âœ… Tag '$TAG' is available"

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Install Dependencies
        run: flutter pub get

      # 4. SECURITY AUDIT
      - name: ðŸ›¡ï¸ Audit Dependencies
        run: |
          # Intentamos ejecutar el audit. Si no existe o falla, no detiene el proceso.
          dart pub outdated --dependency-overrides --dev-dependencies --json || echo "Audit not supported"
        continue-on-error: true

      # 5. CODE GENERATION (Modern Dart Command) + Caching
      - name: ðŸ—ï¸ Generate Code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ðŸ•µï¸ Static Analysis
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: ðŸ§ª Unit Tests
        run: flutter test

      # 7. RELEASE BUILD VERIFICATION (Runs on PRs too!)
      # PRs build unsigned AAB to verify production compilation
      - name: ðŸ—ï¸ Build Release AAB (Dry-Run for PRs)
        if: github.event_name == 'pull_request'
        run: |
          
          # Build WITHOUT signing to verify release compilation
          flutter build appbundle --release
          
          echo "âœ… Release build compiles successfully (unsigned)"

      # 8. ANDROID SIGNING SETUP (Production Only)
      - name: ðŸ” Configure Android Signing
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
          
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=app/upload-keystore.jks
          EOF
          
          echo "âœ… Keystore: android/app/upload-keystore.jks"
          echo "âœ… Properties: android/key.properties"

      - name: ðŸ—ï¸ Build Production AAB (Signed)
        if: github.event_name == 'workflow_dispatch'
        run: |
          flutter build appbundle --release \
            --obfuscate \
            --split-debug-info=build/app/outputs/symbols 
          
          echo "âœ… Signed production AAB built successfully"

      - name: ðŸ—ï¸ Build Production APK (Signed)
        if: github.event_name == 'workflow_dispatch'
        run: |
          flutter build apk --release \
            --obfuscate \
            --split-debug-info=build/app/outputs/symbols 
          
          echo "âœ… Signed production APK built successfully"

      - name: ðŸ“¦ Prepare Debug Symbols
        if: github.event_name == 'workflow_dispatch'
        run: |
          mv build/app/outputs/symbols build/debug-symbols
          echo "âœ… Debug symbols prepared"

      - name: ðŸ“¤ Upload Release Artifacts
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle
          path: |
            build/app/outputs/bundle/release/app-release.aab
            build/app/outputs/apk/release/app-release.apk
            build/debug-symbols/**
          retention-days: 1
          compression-level: 6 

  # -----------------------------------------------------------------
  # JOB 2: PUBLISH RELEASE (Only on manual dispatch)
  # -----------------------------------------------------------------
  publish-release:
    name: ðŸ“¦ Create GitHub Release
    needs: [verify-and-build]
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ðŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-bundle
          path: artifacts

      - name: ðŸ” Verify Downloaded Artifacts
        run: |
          echo "ðŸ“¦ Artifact contents:"
          ls -lhR artifacts/
          
          # Verify expected files exist
          if [[ ! -f "artifacts/app-release.aab" ]]; then
            echo "â›” ERROR: app-release.aab not found in artifacts"
            exit 1
          fi

          if [[ ! -f "artifacts/app-release.apk" ]]; then
            echo "â›” ERROR: app-release.apk not found in artifacts"
            exit 1
          fi
          
          if [[ ! -d "artifacts/debug-symbols" ]]; then
            echo "â›” ERROR: debug-symbols directory not found in artifacts"
            exit 1
          fi
          
          echo "âœ… All required artifacts present"

      - name: ðŸ·ï¸ Prepare Release Assets
        env:
          APP_NAME: ${{ needs.verify-and-build.outputs.app_name }}
          VERSION: ${{ needs.verify-and-build.outputs.version }}
          BUILD: ${{ needs.verify-and-build.outputs.build_number }}
        run: |
          # Move files to current directory with semantic naming
          mv artifacts/app-release.aab ${APP_NAME}-${VERSION}-build${BUILD}.aab
          mv artifacts/app-release.apk ${APP_NAME}-${VERSION}-build${BUILD}.apk
          
          # Zip debug symbols for release attachment
          cd artifacts/debug-symbols
          zip -r ../../debug-symbols-${VERSION}.zip .
          cd ../..
          
          # Verify renamed files
          ls -lh *.aab *.apk *.zip
          echo "âœ… Assets prepared for release"

      # CRITICAL: Tag creation happens AFTER successful build
      # Tags include build number to allow hotfixes (v1.0.0-b1, v1.0.0-b2)
      - name: ðŸŽ‰ Create Release & Tag
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.verify-and-build.outputs.version_tag }}
          name: "Release ${{ needs.verify-and-build.outputs.version }} (Build ${{ needs.verify-and-build.outputs.build_number }})"
          body: |
            ## ðŸš€ Production Release ${{ needs.verify-and-build.outputs.version }}
            
            **Build Number:** ${{ needs.verify-and-build.outputs.build_number }}
            **App:** ${{ needs.verify-and-build.outputs.app_name }}
            
            ### ðŸ“¦ Downloads
            - **Android App Bundle (AAB):** `${{ needs.verify-and-build.outputs.app_name }}-${{ needs.verify-and-build.outputs.version }}-build${{ needs.verify-and-build.outputs.build_number }}.aab`
            - **Android App Bundle (APK):** `${{ needs.verify-and-build.outputs.app_name }}-${{ needs.verify-and-build.outputs.version }}-build${{ needs.verify-and-build.outputs.build_number }}.apk`
            - **Debug Symbols:** `debug-symbols-${{ needs.verify-and-build.outputs.version }}.zip`
            
            ### âœ… Quality Gates Passed
            - âœ… Static Analysis (`flutter analyze`)
            - âœ… Unit Tests (`flutter test`)
            - âœ… Code Generation (`build_runner`)
            - âœ… Version validation (strict semver)
          files: |
            *.aab
            *.apk
            *.zip
          draft: true
          make_latest: true
          generate_release_notes: true
          fail_on_unmatched_files: true
