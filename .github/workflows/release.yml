name: ðŸš€ Production Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # -----------------------------------------------------------------
  # JOB 1: QUALITY GATE & BUILD
  # -----------------------------------------------------------------
  verify-and-build:
    name: ðŸ›¡ï¸ Verify, Build & Package
    runs-on: ubuntu-latest
    outputs:
      app_name: ${{ steps.meta.outputs.APP_NAME }}
      version: ${{ steps.meta.outputs.VERSION }}
      build_number: ${{ steps.meta.outputs.BUILD_NUMBER }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. STRICT VERSION VALIDATION
      - name: ðŸ§  Extract & Validate Metadata
        id: meta
        run: |
          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          APP_NAME=$(yq '.name' pubspec.yaml)
          VERSION_FULL=$(yq '.version' pubspec.yaml)
          
          # STRICT REGEX VALIDATION: Must be x.y.z+n
          if [[ ! "$VERSION_FULL" =~ ^[0-9]+\.[0-9]+\.[0-9]+\+[0-9]+$ ]]; then
            echo "â›” ERROR: Invalid version format in pubspec.yaml"
            echo "   Found: '$VERSION_FULL'"
            echo "   Required format: x.y.z+n (e.g., 1.0.0+1)"
            exit 1
          fi
          
          # Extract components AFTER validation
          VERSION_BASE=${VERSION_FULL%+*}
          BUILD_NUMBER=${VERSION_FULL#*+}
          
          echo "âœ… Validated: $APP_NAME v$VERSION_BASE (Build: $BUILD_NUMBER)"
          
          # Export for subsequent steps
          echo "APP_NAME=$APP_NAME" >> $GITHUB_OUTPUT
          echo "VERSION=v$VERSION_BASE" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      # 2. GIT TAG COLLISION CHECK
      - name: ðŸ›‘ Check Tag Uniqueness
        env:
          TAG: ${{ steps.meta.outputs.VERSION }}
        run: |
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "â›” ERROR: Git tag '$TAG' already exists"
            echo "   Action: Bump version in pubspec.yaml before releasing"
            exit 1
          fi
          echo "âœ… Tag '$TAG' is available"

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ðŸ“¦ Install Dependencies
        run: flutter pub get

      # 3. CODE GENERATION (Modern Dart Command)
      - name: ðŸ—ï¸ Generate Code
        run: dart run build_runner build --delete-conflicting-outputs

      # 4. DECOUPLED CONFIG GENERATION
      # NOTE: Store the entire config JSON as a single secret: ENV_CONFIG_JSON
      # This decouples CI from app config schema - no hardcoded keys!
      - name: ðŸ” Generate Environment Config
        env:
          ENV_CONFIG: ${{ secrets.ENV_CONFIG_JSON }}
        run: |
          if [[ -z "$ENV_CONFIG" ]]; then
            echo "â›” CRITICAL: ENV_CONFIG_JSON secret is missing!"
            echo "   Create it in GitHub Settings > Secrets with your full config JSON"
            exit 1
          fi
          
          # Validate JSON syntax
          echo "$ENV_CONFIG" | jq empty || {
            echo "â›” ERROR: ENV_CONFIG_JSON is not valid JSON"
            exit 1
          }
          
          echo "$ENV_CONFIG" > env.json
          echo "âœ… Environment config generated and validated"

      - name: ðŸ•µï¸ Static Analysis
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: ðŸ§ª Unit Tests
        run: flutter test

      # 5. ANDROID SIGNING SETUP (Fixed Path Resolution)
      - name: ðŸ” Configure Android Signing
        run: |
          # Decode keystore to android/ directory (not android/app/)
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/upload-keystore.jks
          
          # Create key.properties in android/ directory
          # Gradle resolves paths relative to android/, so use direct filename
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=upload-keystore.jks
          EOF
          
          echo "âœ… Keystore configured at android/upload-keystore.jks"

      - name: ðŸ—ï¸ Build Production AAB
        run: |
          flutter build appbundle --release \
            --obfuscate \
            --split-debug-info=build/app/outputs/symbols \
            --dart-define-from-file=env.json

      - name: ðŸ“¦ Package Debug Symbols
        run: |
          cd build/app/outputs/symbols
          zip -r symbols.zip .
          mv symbols.zip ../../../debug-symbols.zip
          cd -

      # 6. SECURITY CLEANUP (Remove sensitive files)
      - name: ðŸ§¹ Remove Sensitive Files
        if: always()
        run: |
          rm -f env.json
          rm -f android/key.properties
          rm -f android/upload-keystore.jks
          echo "âœ… Cleaned up sensitive files"

      - name: ðŸ“¤ Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle
          path: |
            build/app/outputs/bundle/release/app-release.aab
            build/debug-symbols.zip
          retention-days: 1

  # -----------------------------------------------------------------
  # JOB 2: PUBLISH RELEASE (Tag Creation Happens Here!)
  # -----------------------------------------------------------------
  publish-release:
    name: ðŸ“¦ Create GitHub Release
    needs: [verify-and-build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ðŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-bundle
          path: artifacts

      - name: ðŸ·ï¸ Prepare Release Assets
        env:
          APP_NAME: ${{ needs.verify-and-build.outputs.app_name }}
          VERSION: ${{ needs.verify-and-build.outputs.version }}
          BUILD: ${{ needs.verify-and-build.outputs.build_number }}
        run: |
          # Rename with semantic versioning
          mv artifacts/app-release.aab ${APP_NAME}-${VERSION}-build${BUILD}.aab
          mv artifacts/debug-symbols.zip debug-symbols-${VERSION}.zip
          
          # Verify files exist
          ls -lh *.aab *.zip

      # CRITICAL FIX: Tag creation happens AFTER successful build
      # If this step fails, no tag is created - prevents orphaned tags
      - name: ðŸŽ‰ Create Release & Tag
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.verify-and-build.outputs.version }}
          name: "Release ${{ needs.verify-and-build.outputs.version }}"
          body: |
            ## ðŸš€ Production Release ${{ needs.verify-and-build.outputs.version }}
            
            **Build Number:** ${{ needs.verify-and-build.outputs.build_number }}
            **App:** ${{ needs.verify-and-build.outputs.app_name }}
            
            ### ðŸ“¦ Downloads
            - **APK Bundle:** `${{ needs.verify-and-build.outputs.app_name }}-${{ needs.verify-and-build.outputs.version }}-build${{ needs.verify-and-build.outputs.build_number }}.aab`
            - **Debug Symbols:** `debug-symbols-${{ needs.verify-and-build.outputs.version }}.zip`
            
            ### âœ… Quality Gates Passed
            - Static Analysis (flutter analyze)
            - Unit Tests (flutter test)
            - Code Generation (build_runner)
          files: |
            *.aab
            *.zip
          draft: true
          make_latest: true
          generate_release_notes: true
          fail_on_unmatched_files: true